---
title: "flat_performance_evaluation.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
library(assertthat)
library(dplyr)
library(PropCIs)
library(checkmate)
```

<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.
-->
## sens_spe_for_forest 

Calculates sensitivity and specificity of a diagnostic test.
Results are formatted to generate forest plots.
    
```{r function-sens_spe_for_forest}
#' Sensitivity and specificity (for forest plots)
#' 
#' Calculate sensitivity and specificity with confidence intervals from a data frame that contains the results of the index and the reference test. 
#' To be used for displaying the result in a forest plot.
#' 
#' @param data_var Data table containing test results
#' @param index The index test with "Negative" and "Positive" results
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha -- default 95%
#'
#' @return A data table with TP/FP/TN/FN, sensitivity, specificity and confidence intervals
#' @import dplyr
#' @import assertthat 
#' @import PropCIs
#' 
#' @export
sens_spe_for_forest <- function(data_var, index, ref, conf.level = 0.95){
  #verify that these are column names in characters
  assert_that(is.character(index))
  assert_that(is.character(ref))

  # Calculate number of TP, TN, FP, FN, etc.
  TP	<- nrow(data_var[which(data_var[,index] == "Positive" & data_var[,ref] == "Positive"),])
  FP	<- nrow(data_var[which(data_var[,index] == "Positive" & data_var[,ref] == "Negative"),])
  FN	<- nrow(data_var[which(data_var[,index] == "Negative" & data_var[,ref] == "Positive"),])
  TN	<- nrow(data_var[which(data_var[,index] == "Negative" & data_var[,ref] == "Negative"),])

  sens	<- round((TP / (TP + FN))*100, 2)
  sens_CI	<- scoreci(x = TP, n  = (TP + FN), conf.level = conf.level)

  spe		<- round((TN / (TN +FP))*100,2)
  spe_CI	<- scoreci(x = TN, n  = (TN + FP), conf.level = conf.level)
  BA <- round((sens+spe)/2, 2)
  BA_lci <- round((sens_CI$conf.int[1]*100 + spe_CI$conf.int[1]*100)/2, 2)
  BA_hci <- round((sens_CI$conf.int[2]*100 + spe_CI$conf.int[2]*100)/2, 2)
  DOR <- round((TP*TN)/(FP*FN), 2)
  se_dor <- sqrt((1/TP+1/FN+1/FP+1/TN))
  z <- qnorm(1-conf.level/2) 
  DOR_lci <- round(exp(log(DOR) - z*se_dor), 2)
  DOR_hci <- round(exp(log(DOR) + z*se_dor), 2)

  PPV	<- round((TP / (TP + FP))*100, 2)
  NPV	<- round((TN / (TN + FN))*100,2)
  ACC	<- round(((TP + TN) / (TP + FP + FN + TN))*100,2)
  N 		<- TP + TN + FP + FN

  data_to_return_1	<- data.frame(N = N, TP = TP, FP = FP, FN = FN, TN = TN,
                                 Sensitivity = sens, Specificity = (spe),
                                 SensLower = (sens_CI$conf.int[1])*100,
                                 SensUpper = (sens_CI$conf.int[2])*100,
                                 SpeLower = (spe_CI$conf.int[1])*100,
                                 SpeUpper = (spe_CI$conf.int[2])*100,
                                 Balanced_Accuracy = BA,
                                 BAlower = BA_lci,
                                 BAupper = BA_hci,
                                 DOR = DOR,
                                 DORUpper = DOR_hci,
                                 DORLower = DOR_lci,
                                 PPV = PPV,
                                 NPV = NPV,
                                 Accuracy = ACC)
  return(data_to_return_1)
}




```
  
```{r example-sens_spe_for_forest}
library(forestplot)
df <- data.frame(Index = c(rep("Positive", 20), rep("Negative", 20)), Reference = c(rep("Positive", 30), rep("Negative", 10)))
forest_data <- cbind(Test = "Index", sens_spe_for_forest(data_var = df, index = "Index", ref = "Reference", conf.level = 0.95))
forest_data %>% forestplot(mean = Sensitivity, 
                          lower = SensLower, 
                          upper = SensUpper, 
                          labeltext = Test,
                          title = "Sensitivity",
                          zero = NA,
                          xticks = c( 0, 20, 40, 60, 80, 100),
                          txt_gp = fpTxtGp(ticks=gpar(cex=1)),
                          boxsize = .1
                          )
```
  
```{r tests-sens_spe_for_forest}
  df <- data.frame(Index = c(rep("Positive", 20), rep("Negative", 20)), Reference = c(rep("Positive", 10), rep("Negative", 30)))
test_that("sen_spe_for_forest works", {
 expect_error( sens_spe_for_forest(
    data_var = df,
    index = 0.8,
    ref = "Reference",
    conf.level = 0.95
  ))
})
```
  
## sens_spe

Calculates sensitivity and specificity of a diagnostic test.
Results are formatted to generate a table to display.
    
```{r function-sens_spe}
#' Sensitivity and specificity (Table Display)
#' 
#' Calculate sensitivity and specificity with confidence intervals from a data frame that contains the results of the index and the reference test. 
#' To be used for displaying the result in a table.
#' 
#' @param data_var Data table containing test results
#' @param index The index test with "Negative" and "Positive" results
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha -- default 95%
#'
#' @return A data table with TP/FP/TN/FN, sensitivity, specificity and confidence intervals
#' @import dplyr
#' @import assertthat 
#' @import PropCIs
#' @export
sens_spe <- function(data_var, index, ref, conf.level = 0.95){
  #verify that these are column names in characters
  assert_that(is.character(index))
  assert_that(is.character(ref))

  # Calculate number of TP.

table <- sens_spe_for_forest(data_var = data_var, index = index, ref = ref, conf.level = 0.95)

  sens_ci_text <- paste0('[', format(table$SensLower, nsmall = 1), '-', format(table$SensUpper, nsmall = 1), ']')
  spe_ci_text  <- paste0('[', format(table$SpeLower, nsmall = 1), '-', format(table$SpeUpper, nsmall = 1), ']')
  BA_ci_text   <- paste0('[', format(table$BAlower, nsmall = 1), '-', format(table$BAupper, nsmall = 1), ']')
  DOR_ci_text   <- paste0('[', format(table$DORLower, nsmall = 1), '-', format(table$DORUpper, nsmall = 1), ']')


  data_to_return_1	<- c(N = table$N, TP = table$TP, FP = table$FP, FN = table$FN, TN = table$TN, `Sensitivity` = table$Sensitivity, `Sensitivity [95%CI]` = sens_ci_text, `Specificity` = table$Specificity, `Specificity [95%CI]` = spe_ci_text, `Balanced Accuracy` = table$Balanced_Accuracy, `B. Accuracy [95%CI]` = BA_ci_text, `DOR` = table$DOR, `DOR [95%CI]` = DOR_ci_text, PPV = table$PPV, NPV = table$NPV, Accuracy = table$Accuracy )
  names_tp <- names(data_to_return_1)
  data_to_return_1  <- data.frame(t(data_to_return_1))
  colnames(data_to_return_1) <- names_tp
  return(data_to_return_1)
}
```
  
```{r example-sens_spe}
df <- data.frame(Index = c(rep("Positive", 5), rep("Negative", 30), rep("Positive", 5)), Reference = c(rep("Positive", 10), rep("Negative", 30)))
sens_spe(data_var = df, index = "Index", ref = "Reference", conf.level = 0.95)
```
  
```{r tests-sens_spe}
  df <- data.frame(Index = c(rep("Positive", 20), rep("Negative", 20)), Reference = c(rep("Positive", 10), rep("Negative", 30)))
test_that("sen_spe works", {
 expect_error( sens_spe(
    data_var = df,
    index = 0.8,
    ref = "Reference",
    conf.level = 0.95
  ))
})
```
  

## CI_Calc
    
```{r function-CI_Calc}
#' Confidence Interval Calculator
#' 
#' Calculates the confidence interval of a given proportion with normal approximation.
#' 
#' @param alpha significance level
#' @param proportion the proportion
#' @param n sample size
#'
#' @return
#' 
#' @importFrom checkmate expect_number
#' @importFrom stats qnorm
#' @export
CI_Calc <- function(alpha, proportion, n){
  alpha_val         <- 1-alpha/2
  z = qnorm(alpha_val)
  ci = z*sqrt((proportion*(1-proportion))/n)
  return(round(ci, digits = 4))
}
```
  
```{r example-CI_Calc}
CI_Calc(alpha=0.05, proportion=0.62, n= 500)
```
  
```{r tests-CI_Calc}
test_that("CI_calc works", expect_number(CI_Calc(alpha=0.05, proportion=0.8, n= 321)))
```
  

## multi_sen_spe
    
To create a data frame that dsiplays performance characteristics of multiple tests
    
```{r function-multi_sen_spe}
#' multi_sen_spe for Table Display
#' 
#' Calculates and displays sensitivity and specificity with confidence intervals from a data frame for multiple index tests and the reference test. To be used for displaying the result in a table.
#' 
#' @param data_var Data table containing tests results
#' @param list_index A list of index tests with "Negative" and "Positive" results
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha – default 95%
#' @param index_names An optional list containing names of the index tests
#'
#' @return A data table with TP/FP/TN/FN, sensitivity, specificity and confidence intervals for all index tests specified in the list
#' 
#' @export
multi_sen_spe <- function(data_var, list_index, ref, conf.level = 0.95, index_names = NULL){
    performance_display <- data.frame()
  for(i in list_index){
    df <- sens_spe(data_var = data_var, index = i, ref = ref, conf.level = conf.level)
    performance_display <- rbind(performance_display, df)
  }
    ifelse(
    is.null(index_names),
    rownames(performance_display) <-
      list_index,
    rownames(performance_display) <- index_names
  )
  return(performance_display)
}
```
  
```{r example-multi_sen_spe}
library(finddataanalysis)
df <- data.frame(Index1 = c(rep("Positive", 20), rep("Negative", 20)), Index2 = c(rep("Positive", 5), rep("Negative", 35)), Index3 = c(rep("Positive", 9), rep("Negative", 31)), Reference = c(rep("Positive", 10), rep("Negative", 30)))

multi_sen_spe(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95)


```
  
```{r tests-multi_sen_spe}
library(finddataanalysis)

df <- data.frame(Index1 = c(rep("Positive", 20), rep("Negative", 20)), Index2 = c(rep("Positive", 5), rep("Negative", 35)), Index3 = c(rep("Positive", 9), rep("Negative", 31)), Reference = c(rep("Positive", 10), rep("Negative", 30)))

test_that("multi_sen_spe works", {
  expect_true(is.data.frame(multi_sen_spe(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95))) 
})
```

## multi_sen_spe_forest

To create a dataframe that is forest plot friendly with multiple index tests
    
```{r function-multi_sen_spe_forest}
#' multi_sen_spe_forest for forest plots
#' 
#' Calculates and displays sensitivity and specificity with confidence intervals from a data frame for multiple index tests and the reference test. To be used for displaying the result in a table.
#' 
#' @param data_var  Data table containing test results
#' @param list_index A list of index test with "Negative" and "Positive" results
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha – default 95%
#' @param index_names An optional list containing names of the index tests
#'
#' @return A data table with TP/FP/TN/FN, sensitivity, specificity and confidence intervals, to be fed into forestplot function.
#' 
#' @export
multi_sen_spe_forest <- function(data_var, list_index, ref, conf.level = 0.95, index_names = NULL){
  data_to_forest <- data.frame()
  for (i in list_index){
      df <- sens_spe_for_forest(data_var, i, ref, conf.level = 0.95)
      data_to_forest <- rbind(data_to_forest, df)
  }
  ifelse(
    is.null(index_names),
    data_to_forest$Test <-
      list_index,
    data_to_forest$Test <- index_names
  )
    return(data_to_forest)
}
```
  
```{r example-multi_sen_spe_forest}

df <- data.frame(Index1 = c(rep("Positive", 20), rep("Negative", 20)), Index2 = c(rep("Positive", 5), rep("Negative", 35)), Index3 = c(rep("Positive", 9), rep("Negative", 31)), Reference = c(rep("Positive", 10), rep("Negative", 30)))

multi_sen_spe_forest(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95)
```
  
```{r tests-multi_sen_spe_forest}

df <- data.frame(Index1 = c(rep("Positive", 20), rep("Negative", 20)), Index2 = c(rep("Positive", 5), rep("Negative", 35)), Index3 = c(rep("Positive", 9), rep("Negative", 31)), Reference = c(rep("Positive", 10), rep("Negative", 30)))

test_that("multi_sen_spe_forest works", {
  expect_true(is.data.frame(multi_sen_spe_forest(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95))) 
})

```
      
  
  
```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_performance_evaluation.Rmd", vignette_name = "Performance Evaluation")
```
